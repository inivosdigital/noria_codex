# Story 1.1: Database Foundation & User Management

## Status
Done

## Story
**As a** system administrator,
**I want** to establish core database infrastructure and user account functionality,
**so that** users can create accounts and the platform can store essential user data.

## Acceptance Criteria
1. 1.1.1: PostgreSQL database connection established via the local Docker container (Supabase-compatible for deployment)
2. 1.1.2: User table schema created (id, email, password_hash, created_at, goals, stage)
3. 1.1.3: Conversation table schema created (id, user_id, message_text, timestamp, sender_type)
4. 1.1.4: Analysis table schema created (id, user_id, chat_score, timestamp, message_range)
5. 1.1.5: Basic CRUD operations tested and working
6. 1.1.6: Account creation form with email/password validation
7. 1.1.7: Password requirements enforced (8+ chars, mixed case, numbers)

> Local development runs against the Docker Postgres container defined in `docker-compose.postgres.yml`. Hosted deployments can switch the same configuration to Supabase without code changes.

> Documentation alignment: Column name standardized to `stage` across epic, PRD, and architecture docsâ€”implementations must persist the same field name to avoid schema drift.

## Tasks / Subtasks
- [x] Establish FastAPI database connectivity via the local Docker Postgres service (AC: 1.1.1)
  - [x] Configure `apps/api/app/core/database.py` to load environment-driven Postgres settings and ensure connection pooling is ready for async access. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/backend-architecture.md#service-architecture] 
  - [x] Validate `.env` defaults align with the Docker container credentials, failing fast when variables are missing. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/coding-standards.md#critical-fullstack-rules] 
  - [x] Exercise the connection using a lightweight health query to confirm credentials succeed against the local instance. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/tech-stack.md#technology-stack-table] 
- [x] Apply initial database migrations for core tables (AC: 1.1.2, 1.1.3, 1.1.4)
  - [x] Create Alembic migration files aligning with documented schemas for `users`, `conversations`, and `analysis_results`, including constraints and defaults. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#database-schema] 
  - [x] Verify migrations run cleanly against the Docker Postgres instance and remain deployable to Supabase. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#database-schema]
  - [x] Document any variance from the SQL spec directly in the migration comments for PO review. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#migration-strategy] 
- [x] Implement repository and service layer CRUD operations (AC: 1.1.5)
  - [x] Flesh out `UserRepository`, `ConversationRepository`, and `AnalysisRepository` with create/read/update/delete methods mapped to SQLAlchemy models. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/components.md#backend-components] 
  - [x] Wire services through FastAPI dependency injection so routes can access business logic without direct DB coupling. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/backend-architecture.md#dependency-injection] 
  - [x] Cover operations with pytest integration tests using the Docker-backed transactional fixtures. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#backend-tests] 
- [x] Expose REST endpoints for account creation and data access (AC: 1.1.5)
  - [x] Implement `/auth/signup` in `apps/api/app/api/v1/auth/routes.py` to call the user service, enforce password policy, and return the documented payload. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/rest-api-spec.md#rest-api-spec] 
  - [x] Ensure response and error formats align with the unified error handling strategy. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/coding-standards.md#critical-fullstack-rules] 
  - [x] Provide stubs for future hosted-auth integration while accepting local tokenless execution. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/backend-architecture.md#dependency-injection]
- [x] Build Next.js signup experience with validation (AC: 1.1.6, 1.1.7)
  - [x] Scaffold `apps/web/app/(auth)/signup/page.tsx` using React Hook Form + Zod to capture email, password, goals, and consent. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/frontend-architecture.md#form-patterns--validation] 
  - [x] Submit through `userService` that calls the REST signup endpoint and persists the returned user in the local auth store. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/frontend-architecture.md#frontend-services-layer]
  - [x] Enforce password requirements client-side and surface backend validation errors with shadcn form messages. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/security-and-performance.md#authentication-security] 
- [x] Validate functionality end-to-end (AC: 1.1.5, 1.1.6, 1.1.7)
  - [x] Add pytest coverage for repositories/services plus Vitest coverage for the signup form interactions. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#testing-pyramid] 
  - [x] Provide Docker-based seed/reset commands ensuring CRUD operations persist and retrieve real data locally. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#seed-data-plan]
  - [x] Document manual test notes for Docker Postgres connection and signup happy-path while capturing any deviations. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#real-data-policy]

## Dev Notes

### Previous Story Insights
- No previous story document found in `docs/stories`; capture any upstream decisions encountered during implementation for future stories.

### Data Models
- Core entities include `User`, `Conversation`, and `AnalysisResult` with the documented fields and relationships (UUID keys, timestamps, JSON metadata, and stage/chat score constraints). [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/data-models.md#user]
- Database tables must mirror the SQL specification, including default values, constraints, and triggers for analysis queuing and RLS policies. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#database-schema]
- Architecture standardizes the progress column as `stage` (integer 1-3); ensure schemas and migrations persist that name consistently. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/database-schema.md#database-schema]

### API Specifications
- Implement `/auth/signup` to accept email, password, and goals, returning the `User` schema described in the API spec. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/rest-api-spec.md#rest-api-spec]
- Ensure chat and profile endpoints conform to documented request/response types so CRUD tests align with broader conversation flows. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/rest-api-spec.md#rest-api-spec]

### Component Specifications
- Signup experience lives under `app/(auth)/signup` with shadcn UI components and Zustand stores; follow the component/service patterns from the frontend architecture. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/frontend-architecture.md#component-architecture]
- Forms must use React Hook Form + Zod validation with consistent error messaging and remain auth-provider agnostic (local store today, Supabase-ready). [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/frontend-architecture.md#form-patterns--validation]
- Backend services should expose repository-backed business logic modules reused by routes and future background workers. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/backend-architecture.md#service-architecture]

### File Locations
- Frontend surfaces belong in `apps/web/app/(auth)/signup`, reusable logic in `apps/web/services/userService.ts`, and shared types in `packages/shared/src/types`. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/unified-project-structure.md#unified-project-structure]
- Backend implementations should touch `apps/api/app/core`, `apps/api/app/api/v1/auth`, `apps/api/app/repositories`, and related tests under `apps/api/tests`. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/unified-project-structure.md#unified-project-structure]

### Testing Requirements
- Follow the testing pyramid: backend unit/integration with pytest/httpx, frontend unit with Vitest/Testing Library, and prepare Playwright smoke coverage for auth flows. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#testing-pyramid]
- Use real Docker-hosted Postgres data for integration/e2e scenarios; mocks are acceptable only at the unit level. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#real-data-policy]
- Store frontend tests in `apps/web/tests/components` or `tests/services` and backend tests in `apps/api/tests/api/auth`. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#test-organization]

### Technical Constraints
- Password policy requires minimum 8 characters with mixed case and numbers; enforce server-side validation and align frontend messaging. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/security-and-performance.md#authentication-security]
- Maintain standardized error handling and prepare auth helpers so the stack can toggle between local development and Supabase deployment. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/coding-standards.md#critical-fullstack-rules]
- Encrypt conversation and analysis payloads using the Fernet-based encryption approach described for backend storage. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/security-and-performance.md#security-requirements]
- Crisis detection requirement persists for downstream chat flows; ensure repositories/services allow future hooks for crisis events. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/core-workflows.md#primary-coaching-conversation-flow]

### Testing
- Backend: Add pytest suites under `apps/api/tests/api/auth/` and `apps/api/tests/repositories/` using the Docker-connected fixtures. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#backend-tests]
- Frontend: Create Vitest + Testing Library coverage in `apps/web/tests/forms/signup.test.tsx` to verify validation flows. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#frontend-tests]
- E2E: Extend Playwright auth flow spec once signup is functional to cover happy path registration and password errors. [Source: docs/NORIA_FULLSTACK_ARCHITECTURE/testing-strategy.md#e2e-tests]

### Project Structure Notes
- Current core configuration expects PRD files under `docs/prd`, but actual sharded PRD resides in `docs/NORIA_PRD`; keep this discrepancy in mind for tooling until configuration is updated. [Source: .bmad-core/core-config.yaml]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-04 | 0.1.0 | Initial monorepo scaffolding begun; backend/frontend foundations in place but outstanding auth/session work remain | James (Codex) |
| 2025-10-05 | 0.1.1 | Switched local development to Dockerized Postgres, updated tests, and documented Supabase compatibility notes | James (Codex) |

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- 2025-10-06: `uv run pytest` (passes with new CRUD and auth rate limit coverage).
- 2025-10-04: `uv run alembic upgrade head` failed (setuptools package discovery error, resolved by declaring packages and adding `migrations/__init__.py`).
- 2025-10-04: `uv run alembic -c migrations/alembic.ini upgrade head` failed (missing `DATABASE_URL` / `PASSWORD_PEPPER` env values).

### Completion Notes List
- Scaffolded FastAPI backend with async database config, repositories, and signup route.
- Auth password policy enforced in shared security utilities across API and frontend.
- Next.js signup experience implemented with React Hook Form, Zod, and Vitest coverage.
- Added Supabase-aligned RLS policies and analysis trigger to initial migration, including job queue scaffold; verified migrations against Docker Postgres.
- Sanitised Supabase credentials from tracked config, refreshed `.env.example`, and documented rotation workflow.
- Implemented repository update/delete flows with tests plus signup rate limiting and negative-path coverage to close QA findings.

### File List
- .gitignore
- apps/api/.env.example
- apps/api/README.md
- apps/api/app/api/dependencies.py
- apps/api/app/api/v1/auth/routes.py
- apps/api/app/core/config.py
- apps/api/app/main.py
- apps/api/app/repositories/analysis.py
- apps/api/app/repositories/conversation.py
- apps/api/app/repositories/user.py
- apps/api/app/services/analysis_service.py
- apps/api/app/services/conversation_service.py
- apps/api/app/services/user_service.py
- apps/api/app/utils/rate_limiter.py
- apps/api/tests/api/auth/test_signup.py
- apps/api/tests/repositories/test_analysis_repository.py
- apps/api/tests/repositories/test_conversation_repository.py
- apps/api/tests/repositories/test_user_repository.py

## QA Results

- 2025-10-05: `set -a && source apps/api/.env && set +a && UV_CACHE_DIR=... uv run --extra dev pytest` (passes against Docker Postgres).
- 2025-10-05: `pnpm --filter noria-web test` (Vitest signup form coverage).

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Backend and frontend scaffolding generally align with the documented architecture, but the database layer stops short of full CRUD coverage and automated validation for negative auth paths. Security posture is weakened by committed Supabase secrets.

### Refactoring Performed
- None â€“ review was observational only.

### Compliance Check
- Coding Standards: âœ“ Follows shared type usage and FastAPI DI patterns.
- Project Structure: âœ“ Files live under documented directories; migrations follow Alembic layout.
- Testing Strategy: âœ— Repository tests omit update/delete flows promised in AC 1.1.5; no backend regression for password policy failures.
- All ACs Met: âœ— AC 1.1.5 lacks update/delete support and exercising; security requirements from architecture violated by leaked service role key.

### Improvements Checklist
- [ ] Remove the Supabase service role key from `apps/api/.env`, rotate credentials, and ensure secrets live outside version control.
- [ ] Implement and test update/delete paths for users, conversations, and analysis records to satisfy AC 1.1.5.
- [ ] Add API-level tests covering password policy violations (expect HTTP 400) to confirm backend enforcement of AC 1.1.7.
- [ ] Introduce documented rate limiting on `/api/v1/auth/signup` to align with security requirements.

### Security Review
Service role key and other Supabase secrets remain in `apps/api/.env`; even commented, this is a high-severity leak that violates security guidance and must be rotated immediately. Auth endpoints still lack rate limiting, leaving brute-force exposure.

### Performance Considerations
Connection pooling via `async_sessionmaker` is in place and queries stay simple; no additional performance risks identified for this slice.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL â†’ docs/qa/gates/1.1-database-foundation-user-management.yml
Risk profile: Not generated during this review.
NFR assessment: Not generated during this review.

### Recommended Status
[âœ— Changes Required - See unchecked items above]

### Review Date: 2025-10-06 (Second Pass)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Re-review confirms the team closed the prior gaps: secrets are scrubbed from version control, CRUD repositories now support update/delete with coverage, and signup rate limiting plus negative password-path tests align backend behaviour with the security spec.

### Refactoring Performed
- None â€“ verification pass only.

### Compliance Check
- Coding Standards: âœ“ Updated repositories and utilities follow documented patterns and shared types.
- Project Structure: âœ“ New rate limiter and config changes reside in approved locations.
- Testing Strategy: âœ“ Added repository CRUD tests and API negative/limit cases satisfy coverage expectations.
- All ACs Met: âœ“ All acceptance criteria (1.1.1â€“1.1.7) now demonstrably satisfied.

### Improvements Checklist
- [x] Remove Supabase secrets from tracked `.env` and rotate credentials.
- [x] Implement update/delete repository methods with automated coverage.
- [x] Add API regression for weak passwords and rate limit enforcement.
- [ ] Replace in-memory rate limiter with a shared store before scaling beyond a single instance.

### Security Review
Signup rate limiting and password enforcement tests reduce brute-force exposure; ensure follow-through on infrastructure card to swap the in-memory limiter for a distributed implementation prior to horizontal scaling.

### Performance Considerations
Rate limiter and CRUD additions are lightweight; no performance regressions noted.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS â†’ docs/qa/gates/1.1-database-foundation-user-management.yml
Risk profile: Not generated during this review.
NFR assessment: Not generated during this review.

### Recommended Status
[âœ“ Ready for Done]
